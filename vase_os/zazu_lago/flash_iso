#!/bin/bash
. "$(dirname "$0")/../../util_f"
. "$(dirname "$0")/../../..."

if file_ex "${rel}${p_lib}/${rcw_file}"; then
    # Source wrapper
    . "${rel}${p_lib}/${rcw_file}"
fi

# Flash ISO to USB drive
if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Usage: sudo ./main -f <device>"
    echo "Example: sudo ./main -f /dev/sdb"
    echo ""
    echo "Available devices:"
    lsblk -d -o NAME,SIZE,TYPE,MOUNTPOINT | grep disk
    exit 1
fi

ISO="$1"
DEVICE="$2"

if [ ! -f "$ISO" ]; then
    echo "Error: ISO file not found: $ISO"
    exit 1
fi

if [ ! -b "$DEVICE" ]; then
    echo "Error: Device not found: $DEVICE"
    exit 1
fi

warn "This will erase all data on $DEVICE"
lsblk
info "ISO: $ISO"
read -p "Continue? (y/N): " confirm

if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    postop "Aborted"
    exit 0
fi

preop "Flashing ISO to $DEVICE..."
dd if="$ISO" of="$DEVICE" bs=4M status=progress oflag=sync
sync

echo "Creating additional partition for remaining space..."
# Get the size of the USB device in sectors
DISK_SIZE=$(blockdev --getsz "$DEVICE")
# Get ISO size in bytes, convert to sectors (512 bytes each)
ISO_SIZE=$(stat -c%s "$ISO")
ISO_SECTORS=$((ISO_SIZE / 512))

# Create a new partition using the remaining space
echo -e "n\np\n3\n$((ISO_SECTORS + 2048))\n\nw" | fdisk "$DEVICE" >/dev/null 2>&1 || true
sync

echo "Done! USB is ready to boot."
echo "Note: Partition 3 created for remaining space (unformatted)"
