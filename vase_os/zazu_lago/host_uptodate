#!/bin/bash

. "$(dirname "$0")/../../util_f"
. "$(dirname "$0")/../../..."

if file_ex "${rel}${p_lib}/${rcw_file}"; then
    # Source wrapper
    . "${rel}${p_lib}/${rcw_file}"
fi
check_updates_safe() {
    tmpdir=$(mktemp -d)
    trap "rm -rf \$tmpdir" EXIT

    # Copy the local package database
    cp -r /var/lib/pacman/local "$tmpdir/" 2>/dev/null

    # Sync the repository databases to temp location (use system config too)
    if fakeroot pacman -Sy --dbpath "$tmpdir" --config /etc/pacman.conf --logfile /dev/null --disable-sandbox >/dev/null 2>&1; then
        # Get updates and filter out [ignored] packages
        pacman -Qu --dbpath "$tmpdir" --config /etc/pacman.conf --disable-sandbox 2>/dev/null | grep -v '\[ignored\]$'
    fi
}
updates=$(check_updates_safe)
if [ -n "$updates" ]; then
    count=$(echo "$updates" | wc -l)
    die "Pkgs: $count available. Please update system first."
else
    info "System up to date"
fi
