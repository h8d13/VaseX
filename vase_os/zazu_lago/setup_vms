#!/bin/bash

. "$(dirname "$0")/../../util_f"
. "$(dirname "$0")/../../..."

# Base QEMU packages
pkgs_needed="qemu-system-x86 qemu-img qemu-hw-display-virtio-gpu-pci qemu-hw-display-virtio-gpu"

# Add display backend packages based on config
case "$qemu_display" in
    gtk) pkgs_needed="$pkgs_needed qemu-ui-gtk" ;;
    sdl) pkgs_needed="$pkgs_needed qemu-ui-sdl" ;;
esac

# Add audio backend packages based on config
case "$audio_backend" in
    pipewire) pkgs_needed="$pkgs_needed qemu-audio-pipewire" ;;
esac

# Add GL renderer if enabled
[ "$qemu_gl" = "on" ] && pkgs_needed="$pkgs_needed virglrenderer"

# Note: qemu-vdagent for clipboard is built into qemu-system-x86, no extra package needed

missing_pkgs=""

preop "Checking VM packages..."
for pkg in $pkgs_needed; do
    if ! to_devnull pacman -Qi "$pkg"; then
        postop "Missing: $pkg"
        missing_pkgs="$missing_pkgs $pkg"
    else
        version=$(pacman -Qi "$pkg" 2>/dev/null | grep "^Version" | awk '{print $3}')
        preop "Found: $pkg ($version)"
    fi
done

if [ -n "$missing_pkgs" ]; then
    preop "Installing missing packages:$missing_pkgs"
    pacman -S --noconfirm --needed $missing_pkgs
else
    preop "All packages already installed. Skipping..."
fi
