#!/bin/bash
#rcw
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

info() {
    [ "${DEBUGS:-1}" = "1" ] && echo -e "${BLUE}[INFO]${NC} $*"
}
warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
reop() { echo -e "${GREEN}[OKAY]${NC} $*"; }
die() {
    echo -e "${RED}[ERROR]${NC} $*";
    exec 1>&- 2>&-
    wait
    exit 1
}
# Color-only functions (no tags) for inline use
c_green() { echo -e "${GREEN}$*${NC}"; }
c_red() { echo -e "${RED}$*${NC}"; }
c_cyan() { echo -e "${CYAN}$*${NC}"; }
time_c() { echo -e "${CYAN}$*${NC}"; }
get_usec() {
    date +%s%6N
}
fmt_dur() {
    local usec=$1
    local sec=$((usec / 1000000))
    local us=$((usec % 1000000))
    local ms=$((us / 1000))
    local us_only=$((us % 1000))
    if [ $sec -gt 0 ]; then
        printf "%d.%03ds" $sec $((us / 1000))
    elif [ $ms -gt 0 ]; then
        printf "%d.%03dms" $ms $us_only
    else
        printf "%dμs" $us
    fi
}
rcw() {
    local cmd="$*"
    [ "${DEBUGS}" = "1" ] && echo -e "${BLUE}[INFO]${NC} Running: $cmd"
    local t_start
    t_start=$(get_usec)
    eval "$cmd"
    local rc=$?
    local t_end
    t_end=$(get_usec)
    local dur=$((t_end - t_start))
    local check="✓"
    local cross="✗"
    local clock="【┘】"

    if [ "$TIMING" = "1" ]; then
        local t_str
        t_str=$(fmt_dur $dur)
        if [ "$COLORS" = "1" ]; then
            echo -e "$(c_cyan "[TIME]") ${t_str} ${clock}"
        else
            echo -e "[TIME] ${t_str} ${clock}"
        fi
    fi
    if [ $rc -eq 0 ]; then
        if [ "$COLORS" = "1" ]; then
            echo -e "$(c_green "[SUCCESS]") Exit: ${rc} ${check}"
        else
            echo -e "[SUCCESS] Exit: ${rc} ${check}"
        fi
    else
        if [ "$COLORS" = "1" ]; then
            echo -e "$(c_red "[ERROR]") Exit: ${rc} ${cross}"
        else
            echo -e "[ERROR] Exit: ${rc} ${cross}"
        fi
    fi
    return $rc
}
init_log() {
    if [ "$TEELOG" = "1" ]; then
        local log_file="${1:-./vase.log}"
        if [ "$LOGCLR" = "1" ]; then
            # Keep colors in log
            if [ "$LOGMEM" = "0" ]; then
                true > "$log_file"
            fi
            exec > >(tee -a "$log_file") 2>&1
        else
            # Strip colors from log
            if [ "$LOGMEM" = "0" ]; then
                true > "$log_file"
                exec > >(tee -a >(sed 's/\x1b\[[0-9;]*m//g' > "$log_file")) 2>&1
            else
                exec > >(tee -a >(sed 's/\x1b\[[0-9;]*m//g' >> "$log_file")) 2>&1
            fi
        fi
        info "Logging to: $log_file"
    fi
}
